OLDGROUP := $(shell cat groupname.out)
GROUPFILE := "groupname.out"
TIMESTAMP := $(shell date +'%s')
USER := $(shell whoami)
NEWGROUP := editions-$(USER)-$(TIMESTAMP)
REGION := centralus

# Make sure to update also in .gitignore if changed
AUTOGENERATED_STGACCOUNT_TEMPLATE := "editions.stgaccount.json"

default: clean groupfile
	azure group create --name $(NEWGROUP) --location $(REGION) --template-file editions.json

dev: clean groupfile
ifndef VHD
$(error "Must set location of VHD, e.g., 'make dev VHD=http://dockereditions.blob.core.windows.net/mobylinux/mobylinux.vhd' ")
endif
	python stg_account_arm_template.py $(VHD) $(AUTOGENERATED_STGACCOUNT_TEMPLATE)
	azure group create --name $(NEWGROUP) --location $(REGION) --template-file $(AUTOGENERATED_STGACCOUNT_TEMPLATE)

groupfile:
	echo $(NEWGROUP) >$(GROUPFILE)

clean:
	azure group delete $(OLDGROUP) -q --nowait || true
	rm -f $(GROUPFILE)

walinuxagent:
	make -C dockerfiles/walinuxagent push
