OLDGROUP := $(shell cat groupname.out)
GROUPFILE := "groupname.out"
TIMESTAMP := $(shell date +'%s')
USER := $(shell whoami)
NEWGROUP := editions-$(USER)-$(TIMESTAMP)
NEWDDCGROUP := editions-$(USER)-$(TIMESTAMP)
REGION := centralus
STG_ACCOUNT := dockereditions
VHD := "http://$(STG_ACCOUNT).blob.core.windows.net/mobylinux/a8d9a06d709c2f7e294b0474c0222eb7-mobylinux.vhd"

# Make sure to update also in .gitignore if changed
AUTOGENERATED_STGACCOUNT_TEMPLATE := "editions.stgaccount.json"
AUTOGENERATED_STGACCOUNT_DDC_TEMPLATE := "editions.stgaccount.ddc.json"

default: clean groupfile
	azure group create --name $(NEWGROUP) --location $(REGION) --template-file editions.json

dev: clean groupfile
	python stg_account_arm_template.py $(VHD) $(AUTOGENERATED_STGACCOUNT_TEMPLATE) $(AUTOGENERATED_STGACCOUNT_DDC_TEMPLATE)
	azure group create --name $(NEWGROUP) --location $(REGION) --template-file $(AUTOGENERATED_STGACCOUNT_TEMPLATE)
	azure group create --name $(NEWDDCGROUP) --location $(REGION) --template-file $(AUTOGENERATED_STGACCOUNT_DDC_TEMPLATE)

groupfile:
	echo "${NEWGROUP} ${NEWDDCGROUP}" >$(GROUPFILE)

clean:
	azure group delete $(OLDGROUP) -q --nowait || true
	rm -f $(GROUPFILE)

walinuxagent:
	make -C dockerfiles/walinuxagent push

shell:
	make -C dockerfiles/xplatcli shell BIND_DIR=$(shell pwd)

login:
	make -C dockerfiles/xplatcli login
