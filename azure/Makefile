.PHONY: release

OLDGROUP := $(shell cat groupname.out)
GROUPFILE := "groupname.out"
TIMESTAMP := $(shell date +'%s')
USER := $(shell whoami)
NEWGROUP := editions-$(USER)-$(TIMESTAMP)
NEWDDCGROUP := editions-ddc-$(USER)-$(TIMESTAMP)
REGION := centralus
STG_ACCOUNT := dockereditions
VHD := "http://$(STG_ACCOUNT).blob.core.windows.net/mobylinux/a8d9a06d709c2f7e294b0474c0222eb7-mobylinux.vhd"
AD_APP_ID := ""
AD_APP_SECRET := ""
SSH_PUBKEY := ""
DDC_TENANT_ID := ""


# Make sure to update also in .gitignore if changed
AUTOGENERATED_STGACCOUNT_TEMPLATE := "editions.stgaccount.json"
AUTOGENERATED_STGACCOUNT_DDC_TEMPLATE := "editions.stgaccount.ddc.json"

define create_group_from_template
	azure group create \
	--parameters "{ \
		\"adServicePrincipalAppID\": {\"value\": \"$(AD_APP_ID)\"}, \
		\"adServicePrincipalAppSecret\": {\"value\": \"$(AD_APP_SECRET)\"}, \
		\"sshPublicKey\": {\"value\": \"$(SSH_PUBKEY)\"} \
	}" \
	--name $(1) --location $(REGION) --template-file $(2)
	echo $(1) >$(GROUPFILE)
endef

default: clean
	$(call create_group_from_template,$(NEWGROUP),editions.json)

ddc: clean
	python stg_account_arm_template.py $(VHD) $(AUTOGENERATED_STGACCOUNT_DDC_TEMPLATE)
	$(call create_group_from_template,$(NEWDDCGROUP),$(AUTOGENERATED_STGACCOUNT_DDC_TEMPLATE))

dev: clean
	python stg_account_arm_template.py $(VHD) $(AUTOGENERATED_STGACCOUNT_TEMPLATE)
	$(call create_group_from_template,$(NEWGROUP),$(AUTOGENERATED_STGACCOUNT_TEMPLATE))

clean:
	azure group delete $(OLDGROUP) -q --nowait || true
	rm -f $(GROUPFILE)
	rm -f release/tmp/* release/dist/*

walinuxagent:
	make -C dockerfiles/walinuxagent push

shell:
	make -C dockerfiles/xplatcli shell BIND_DIR=$(shell pwd)

login:
	make -C dockerfiles/xplatcli login