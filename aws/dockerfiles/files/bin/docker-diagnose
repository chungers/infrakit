#!/bin/sh

set -e

DIAGNOSTICS_MAGIC_PORT=44554

platform()
{
	# TODO: This will need to be changed if the current configuration of
	# system containers are not invoked via 'docker run' anymore
	#
	# (and/or might be more elegant to pass in the platform via environment
	# variables, etc.)
	PLATFORM=$(docker images | grep aws)
	if [ $? -eq 0 ]; then
		echo "aws"
	else
		echo "azure"
	fi
}

if [ "$(platform)" = "aws" ]
then
	# Get instance private IP from AWS metadata service if on AWS.
	METASERVER_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4/)
else
	# Azure shell is run with --net host so use localhost.
	METASERVER_ADDR=localhost
fi

NODES=$(curl -s "${METASERVER_ADDR}:9024/instances/all/")
if [ $? -ne 0 ]; then
	>&2 echo "Sorry, there was an error getting IPs for the cluster."
	>&2 echo "Are you invoking $0 from a manager node?"
	exit 1
fi

# Session is set to a pseudo-random string combined with the current timestamp.
# This should minimize the probability of collision while also providing
# information about when the report was collected.
SESSION="$(date +'%s')-$(dd if=/dev/urandom bs=128 count=1 2>/dev/null | base64 | tr -d "=+/" | dd bs=32 count=1 2>/dev/null)"

for NODE in ${NODES}
do
	curl -X POST \
		-F "session=${SESSION}" \
		"http://${NODE}:${DIAGNOSTICS_MAGIC_PORT}/diagnose" || true
done

echo "Done requesting diagnostics."
echo "Your diagnostics session ID is ${SESSION}"
echo "Please provide this session ID to the maintainer debugging your issue."
