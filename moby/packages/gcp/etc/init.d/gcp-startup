#!/sbin/openrc-run

description="Run startup/shutdown scripts on Docker GCP edition"

depend()
{
  need net
  need docker
}

metadata() {
  curl -sfH 'Metadata-Flavor: Google' http://metadata.google.internal/computeMetadata/v1/${1}
}

start()
{
  ebegin "Pre-load docker images"
  for IMAGE in $( ls /var/dockerimages/*.tar ); do
    echo "Loading image ${IMAGE}"
    docker load --input ${IMAGE}
    rm -f ${IMAGE}
  done
  eend 0

  ebegin "Run startup script"

  temp_file=$(mktemp)
  metadata /instance/attributes/startup-script > ${temp_file}
  [ -s "${temp_file}" ] && sh "${temp_file}"
  rm -f "${temp_file}"

  eend 0
}

stop()
{
  ebegin "Run shutdown script"

  temp_file=$(mktemp)
  metadata /instance/attributes/shutdown-script > ${temp_file}
  [ -s "${temp_file}" ] && sh "${temp_file}"
  rm -f "${temp_file}"

  eend 0
}
