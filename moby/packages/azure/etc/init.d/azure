#!/sbin/openrc-run

description="Bootstrap procedure if running on Docker Azure edition"

depend()
{
	need docker
	need net
}

start()
{
	[ "$(mobyplatform)" != "azure" ] && exit 0
	ebegin "Running Azure-specific initialization"

	export DOCKER_FOR_IAAS_VERSION="#EDITION_VERSION#"

	for i in $(seq 1 20)
	do
		einfo "Pulling Windows Azure Linux Agent container"

		docker pull docker4x/agent-azure:$DOCKER_FOR_IAAS_VERSION >/dev/null

		if [ $? -eq 0 ]
		then
			break
		fi

		# Wait for... network to come up?  DNS servers to be reachable?
		# Not certain, but Azure continually fails to achieve this pull so
		# far because it can't dial the DNS lookup properly.
		# 
		# TODO: Debug.
		sleep 5
	done

	einfo "Running Windows Azure Linux Agent container"

	# "Fake" /etc/hostname setup for persistence across reboots
	#
	# Note the bind mount in 'docker run' below.
	if [ ! -d /var/etc/ ]
	then
		mkdir -p /var/etc
	fi
	if [ ! -d /var/home/docker ]
	then
		mkdir -p /var/home/docker
		chown -R docker:docker /var/home/docker
	fi
	if [ ! -f /var/etc/hostname ]
	then
		echo "moby" >/var/etc/hostname
	fi

	if [ -f /var/lib/waagent/provisioned ]
	then
		# During provisioning, the Azure agent usually does this, but
		# on reboots, it will need to be invoked "manually".
		hostname -F /var/etc/hostname
		kill -HUP "$(pidof dhcpcd)"
	fi

	ebegin "Pre-load docker images"
	for IMAGE in $( ls /dockerimages/*.tar ); do
		echo "Loading image ${IMAGE}"
		docker load --input ${IMAGE}
		rm -f ${IMAGE}
	done
	eend 0

	docker volume create --name sshkey
	docker run -d \
		--privileged \
		--name agent \
		--ipc host \
		--pid host \
		--net host \
		--uts host \
		--label com.docker.editions.system \
		--restart unless-stopped \
		--log-opt max-size=50m \
		-e DOCKER_FOR_IAAS_VERSION \
		-v /usr/bin/docker:/usr/local/bin/docker:ro \
		-v /mnt:/mnt \
		-v /etc:/etc \
		-v /var/etc/docker:/var/etc/docker \
		-v sshkey:/etc/ssh \
		-v /var/etc/hostname:/etc/hostname \
		-v /var/home:/home \
		-v /var/run/docker.sock:/var/run/docker.sock \
		-v /var/log:/var/log \
		-v /lib/modules:/lib/modules \
		-v /lib/firmware:/lib/firmware \
		-v /var/lib/waagent:/var/lib/waagent \
		"docker4x/agent-azure:$DOCKER_FOR_IAAS_VERSION"

	# Wait for docker user to be added by agent.
	while [ ! -d /home/docker ]
	do
		sleep 5
	done

	# TODO: Make this cleaner.
	# User gets added by waagent.
	# Need to unlock it to login via SSH.
	passwd -u docker
	checkpath --directory --mode 0700 /home/docker/.ssh

	# Wait for WALinux agent provisioning to finish before invoking the
	# passed custom data.  This assures us that hostname etc. is set
	# correctly before running, say, swarm commmands.
	while [ ! -f /var/lib/waagent/provisioned ]
	do
		sleep 5
	done

	ebegin "Pulling Azure lookup tool"
	ENABLE="no"
	# pull our lookup tool
	docker pull docker4x/lookup-azure:$DOCKER_FOR_IAAS_VERSION
	PULLED=$?
	eend $PULLED

	ebegin "Checking external logging config"
	if [ $PULLED -eq 0 ]
	then
		ENABLE=$(docker run --rm -it -e ACCOUNT_ID -e TENANT_ID -e APP_ID -e APP_SECRET -e GROUP_NAME docker4x/lookup-azure:$DOCKER_FOR_IAAS_VERSION enableExtLogs)
		if [ $? -eq 1 ]
		then
			einfo "No logging preference can be determined"
		fi
	fi

	if [ "$ENABLE" = "yes" ]
	then
		einfo "Update daemon for External logging"
		cat <<EOF >/etc/docker/daemon.json
{
	"log-driver": "syslog",
	"log-opts": {
		"syslog-address": "udp://localhost:514",
		"tag": "{{.Name}}/{{.ID}}"
	}
}
EOF

		# Ensure correct hostname according to Azure and reload daemon config
		service docker restart
	fi
	eend $?

	. /var/lib/waagent/CustomData

	eend 0
}

stop()
{
	[ "$(mobyplatform)" != "azure" ] && exit 0
	docker rm -f agent || true
	passwd -l docker
}
